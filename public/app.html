<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>iseehalo ‚Äî Web App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #000;
      --panel: #0c0c0c;
      --panel-alt: #111;
      --accent: #1DB954;
      --halo: #FFF59E;
      --text: #fff;
      --muted: #aaa;
      --border: #222;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, #1c1c1c 0, #000 45%);
      color: var(--text);
      /* ‚ùå no flex here ‚Äì let the page scroll normally */
    }

    .app-shell {
      min-height: 100vh;
      display: grid;
      grid-template-columns: 240px minmax(0, 1fr);
      gap: 0;
    }

    @media (max-width: 900px) {
      .app-shell {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      .sidebar {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
      }
      .nav-links {
        flex-direction: row;
      }
    }

    /* Sidebar */

    .sidebar {
      background: #050505;
      border-right: 1px solid var(--border);
      padding: 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .brand {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.4px;
      display: inline-flex;
      align-items: center;
      gap: 0;
    }
    .isee { color: #fff; }
    .halo { color: var(--halo); }

    .tagline {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
      max-width: 200px;
    }

    .nav-links {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 12px;
    }

    .nav-btn {
      width: 100%;
      text-align: left;
      background: transparent;
      border: 0;
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-btn span.icon {
      font-size: 16px;
    }

    .nav-btn.active {
      background: #181818;
      color: #fff;
    }

    .nav-btn:hover {
      background: #151515;
      color: #fff;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 12px;
      color: var(--muted);
    }

    .sidebar-footer .credits {
      font-size: 13px;
      color: var(--halo);
      font-weight: 600;
    }

    .sidebar-footer button {
      margin-top: 6px;
      background: transparent;
      border: 0;
      color: #888;
      font-size: 12px;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
    }

    /* Main area */

    .main {
      background: #000;
      display: flex;
      flex-direction: column;
      /* no max-height, let content grow */
    }

    .top-bar {
      padding: 12px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(16px);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .top-title {
      font-size: 16px;
      font-weight: 600;
    }

    .user-chip {
      font-size: 13px;
      color: var(--muted);
    }
    .user-chip strong { color: #fff; }

    .content {
      flex: 1;
      padding: 16px 18px 90px; /* bottom padding so it doesn't sit under the player bar */
      /* no overflow here so the whole page scrolls */
    }

    section.view {
      display: none;
    }
    section.view.active {
      display: block;
    }

    /* Feed (Home) */

    .feed {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      background: var(--panel);
      border-radius: 14px;
      padding: 12px 12px 10px;
      border: 1px solid rgba(255,255,255,0.03);
    }

    .post-header {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 8px;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }

    .post-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .post-caption {
      font-size: 14px;
      margin: 4px 0 6px;
    }

    .post-tag-song {
      margin-top: 4px;
      font-size: 12px;
      color: var(--accent);
    }

    /* Songs */

    .song-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
    }

    .song-card {
      background: var(--panel);
      border-radius: 14px;
      padding: 10px;
      display: flex;
      gap: 10px;
      border: 1px solid rgba(255,255,255,0.03);
    }

    .song-cover {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
    }

    .song-meta {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .song-title {
      font-size: 14px;
      font-weight: 600;
    }

    .song-artist {
      font-size: 12px;
      color: var(--muted);
    }

    .song-streams {
      font-size: 11px;
      color: #777;
      margin-top: 2px;
    }

    .song-play-btn {
      margin-top: 6px;
      font-size: 12px;
      border-radius: 999px;
      border: 0;
      padding: 5px 10px;
      cursor: pointer;
      background: #1DB954;
      color: #000;
      font-weight: 600;
      align-self: flex-start;
    }

    /* Shop */

    .shop-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .shop-layout {
        grid-template-columns: 1fr;
      }
    }

    .shop-section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .product-card, .copy-card {
      background: var(--panel);
      border-radius: 14px;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.04);
      font-size: 13px;
    }

    .product-thumb {
      width: 100%;
      border-radius: 10px;
      height: 120px;
      object-fit: cover;
      background: #222;
      margin-bottom: 6px;
    }

    .product-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .product-price {
      color: var(--halo);
      font-size: 13px;
    }

    .product-cta, .copy-cta {
      margin-top: 6px;
      width: 100%;
      border-radius: 999px;
      border: 0;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: #333;
      color: #eee;
    }

    .product-cta.disabled, .copy-cta.disabled {
      opacity: 0.6;
      cursor: default;
    }

    .copy-song {
      font-weight: 600;
    }

    .copy-meta {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* Profile */

    .profile-card {
      max-width: 480px;
      background: var(--panel);
      border-radius: 16px;
      padding: 14px 14px 12px;
      border: 1px solid rgba(255,255,255,0.04);
    }

    .profile-header {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 10px;
    }

    .profile-avatar {
      width: 56px;
      height: 56px;
      border-radius: 999px;
      background-size: cover;
      background-position: center;
      background-color: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }

    .profile-name {
      font-weight: 600;
      font-size: 15px;
    }

    .profile-email {
      font-size: 12px;
      color: var(--muted);
    }

    .badge-premium {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 8px;
      background: rgba(255,245,158,0.08);
      border: 1px solid rgba(255,245,158,0.3);
      font-size: 11px;
      margin-top: 4px;
    }

    .badge-premium span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--halo);
    }

    .profile-stats {
      display: flex;
      gap: 16px;
      margin-top: 10px;
      font-size: 13px;
    }

    .profile-stats div strong {
      display: block;
      font-size: 14px;
    }

    .profile-bio {
      font-size: 13px;
      color: var(--muted);
      margin-top: 10px;
    }

    .profile-actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-outline {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: #eee;
      font-size: 12px;
      padding: 6px 10px;
      cursor: pointer;
    }

    .btn-outline.accent {
      border-color: var(--accent);
      color: var(--accent);
    }

    .profile-section-heading {
  margin-top: 14px;
  font-size: 13px;
  font-weight: 600;
}

.profile-list {
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  font-size: 13px;
}

.profile-list-item {
  padding: 8px 10px;
  border-radius: 12px;
  background: var(--panel-alt);
  border: 1px solid rgba(255,255,255,0.04);
  display: flex;
  align-items: center;
  gap: 8px;
}

.profile-list-cover {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background-size: cover;
  background-position: center;
  background-color: #222;
  flex-shrink: 0;
}

.profile-list-main {
  flex: 1;
}

.profile-list-title {
  font-weight: 600;
  font-size: 13px;
}

.profile-list-sub {
  font-size: 12px;
  color: var(--muted);
}

.profile-list-meta {
  font-size: 12px;
  color: var(--halo);
  text-align: right;
}

    /* Player bar*/

    .player-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #050505;
      border-top: 1px solid var(--border);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
      z-index: 20;
    }

    .player-left {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .player-cover {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
      background: #222;
      flex-shrink: 0;
    }

    .player-meta {
      display: flex;
      flex-direction: column;
      max-width: 180px;
    }

    .player-title {
      font-weight: 600;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .player-artist {
      color: var(--muted);
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .player-center {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .player-btn {
      border-radius: 999px;
      border: 0;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      background: #222;
      color: #eee;
    }

    .player-btn.main {
      background: #1DB954;
      color: #000;
      font-weight: 600;
      padding: 4px 12px;
    }

    .player-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      flex: 1;
    }

    .player-right audio {
      width: 180px;
      max-width: 40vw;
    }

    @media (max-width: 600px) {
      .player-bar {
        flex-direction: column;
        align-items: stretch;
      }
      .player-left {
        width: 100%;
      }
      .player-meta {
        max-width: none;
      }
      .player-right audio {
        width: 100%;
        max-width: 100%;
      }
    }

    /* Now Playing panel (Songs view) */
.now-playing {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  margin-bottom: 16px;
  border-radius: 16px;
  background: linear-gradient(135deg, #181818, #050505);
  border: 1px solid rgba(255,255,255,0.06);
}

.now-playing-cover {
  width: 64px;
  height: 64px;
  border-radius: 12px;
  object-fit: cover;
  background: #222;
  flex-shrink: 0;
}

.now-playing-meta {
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: 0;
}

.now-playing-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--muted);
}

.now-playing-title {
  font-size: 15px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.now-playing-artist {
  font-size: 12px;
  color: var(--muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.now-playing-streams {
  font-size: 11px;
  color: #888;
}


    /* Now Playing panel (Songs view) */
.now-playing-full {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle at top, #2c0c0c 0, #000 60%);
  display: none;              /* shown via JS */
  flex-direction: column;
  padding: 16px 20px 24px;
  z-index: 50;
  color: #fff;
}

.now-playing-full-inner {
  max-width: 480px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  height: 100%;
}

.npf-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 14px;
}

.npf-header-btn {
  background: transparent;
  border: 0;
  color: #fff;
  font-size: 20px;
  cursor: pointer;
}

.npf-header-title {
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--muted);
}

.npf-cover-wrap {
  margin-top: 16px;
  display: flex;
  justify-content: center;
}

.npf-cover {
  width: min(340px, 90vw);
  aspect-ratio: 1 / 1;
  border-radius: 24px;
  object-fit: cover;
  background: #222;
}

.npf-track-meta {
  margin-top: 16px;
  text-align: center;
}

.npf-track-title {
  font-size: 18px;
  font-weight: 600;
}

.npf-track-artist {
  font-size: 13px;
  color: var(--muted);
  margin-top: 2px;
}

.npf-track-streams {
  font-size: 11px;
  color: #d0d0d0;
  margin-top: 4px;
}

.npf-progress {
  margin-top: 18px;
}

.npf-times {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: var(--muted);
  margin-bottom: 4px;
}

.npf-seek {
  width: 100%;
}

.npf-controls {
  margin-top: 22px;
  display: flex;
  justify-content: center;
  gap: 22px;
  align-items: center;
}

.npf-ctrl-btn {
  background: transparent;
  border: 0;
  color: #fff;
  font-size: 20px;
  cursor: pointer;
}

.npf-ctrl-btn.main {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: #ff4455;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
}


    /* Auth overlay */

    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .auth-overlay-inner {
      background: #111;
      padding: 22px 20px 18px;
      border-radius: 16px;
      max-width: 360px;
      text-align: center;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
    }

    .auth-overlay-inner h2 {
      margin: 0 0 6px;
      font-size: 18px;
    }
    .auth-overlay-inner p {
      font-size: 13px;
      color: var(--muted);
      margin: 0 0 12px;
    }
    .auth-overlay-inner a {
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
    }

    /* Messages */

    .msg {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 10px;
    }
    .msg.error { color: #ff7a7a; }
    .msg.success { color: #8ef18e; }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div>
        <div class="brand">
          <span class="isee">isee</span><span class="halo">halo</span>
        </div>
        <div class="tagline">Music marketplace where fans & artists share the upside.</div>
      </div>

      <nav class="nav-links">
        <button class="nav-btn active" data-view="home">
          <span class="icon">üè†</span> <span>Home</span>
        </button>
        <button class="nav-btn" data-view="songs">
          <span class="icon">üéß</span> <span>Songs</span>
        </button>
        <button class="nav-btn" data-view="shop">
          <span class="icon">üõí</span> <span>Shop</span>
        </button>
        <button class="nav-btn" data-view="profile">
          <span class="icon">üë§</span> <span>Profile</span>
        </button>
      </nav>

      <div class="sidebar-footer">
        <div id="sidebarCredits" class="credits">Credits: ‚Äî</div>
        <button id="btnSignOut">Sign out</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="top-bar">
        <div class="top-title" id="topTitle">Home</div>
        <div class="user-chip" id="userChip">
          Signed in as <strong>‚Äî</strong>
        </div>
      </header>

      <div class="content">
        <div id="globalMsg" class="msg"></div>

        <!-- HOME / FEED -->
        <section id="view-home" class="view active">
          <h2 style="font-size:16px;margin:0 0 10px;">Feed</h2>
          <div id="feed" class="feed"></div>
        </section>

        <!-- SONGS -->
       <section id="view-songs" class="view">
          <h2 style="font-size:16px;margin:0 0 10px;">Songs on iseehalo</h2>
          <p style="font-size:12px;color:var(--muted);margin-top:0;margin-bottom:8px;">
            Browse songs available on the platform. Tap a track to start playing.
          </p>

         <!-- Now Playing panel -->
       <div id="nowPlaying" class="now-playing" style="display:none;">
       <img id="nowPlayingCover" class="now-playing-cover" src="" alt="Cover" />
      <div class="now-playing-meta">
      <div class="now-playing-label">Now playing</div>
      <div id="nowPlayingTitle" class="now-playing-title">‚Äî</div>
      <div id="nowPlayingArtist" class="now-playing-artist">‚Äî</div>
      <div id="nowPlayingStreams" class="now-playing-streams"></div>
     </div>
    </div>

    <div id="songsGrid" class="song-grid"></div>
    </section>


        <!-- SHOP -->
        <section id="view-shop" class="view">
          <h2 style="font-size:16px;margin:0 0 10px;">Shop</h2>
          <p style="font-size:12px;color:var(--muted);margin-top:0;margin-bottom:8px;">
            Buy limited song copies or physical products using your credits.
          </p>

          <div class="shop-layout">
            <!-- Left: Song copies -->
            <div>
              <div class="shop-section-title">Song copies</div>
              <div id="copiesList"></div>
            </div>

            <!-- Right: Products -->
            <div>
              <div class="shop-section-title">Products</div>
              <div id="productGrid" class="product-grid"></div>
            </div>
          </div>
        </section>

        <!-- PROFILE -->
        <section id="view-profile" class="view">
          <h2 style="font-size:16px;margin:0 0 10px;">Profile</h2>
          <div id="profileCard" class="profile-card"></div>
        </section>
      </div>
    </main>
  </div>

    <!-- Player bar -->
  <div class="player-bar" id="playerBar" style="display:none;">
    <div class="player-left">
      <img id="playerCover" class="player-cover" src="" alt="Cover" />
      <div class="player-meta">
        <div class="player-title" id="playerTitle">‚Äî</div>
        <div class="player-artist" id="playerArtist">‚Äî</div>
      </div>
    </div>

    <div class="player-center">
      <button class="player-btn" id="playerPrev">‚èÆ</button>
      <button class="player-btn main" id="playerPlayPause">‚ñ∂</button>
      <button class="player-btn" id="playerNext">‚è≠</button>
      <button class="player-btn" id="playerReplay">üîÅ</button>
    </div>

    <div class="player-right">
      <audio id="audioPlayer"></audio>
    </div>
  </div>


  <!-- Auth overlay -->
  <div class="auth-overlay" id="authOverlay" style="display:none;">
    <div class="auth-overlay-inner">
      <h2>Sign in to continue</h2>
      <p>
        To use the iseehalo web app you need an account.
        You can sign in or create an account from the auth page.
      </p>
      <p>
        <a href="/auth.html">Go to sign in / sign up ‚Üí</a>
      </p>
    </div>
  </div>

    <!-- Full-screen Now Playing overlay -->
  <div id="nowPlayingFull" class="now-playing-full">
    <div class="now-playing-full-inner">
      <div class="npf-header">
        <button id="npfClose" class="npf-header-btn">‚Üê</button>
        <div class="npf-header-title">Now Playing</div>
        <button id="npfLike" class="npf-header-btn">‚ô°</button>
      </div>

      <div class="npf-cover-wrap">
        <img id="npfCover" class="npf-cover" src="" alt="Cover" />
      </div>

      <div class="npf-track-meta">
        <div id="npfTitle" class="npf-track-title">‚Äî</div>
        <div id="npfArtist" class="npf-track-artist">‚Äî</div>
        <div id="npfStreams" class="npf-track-streams"></div>
      </div>

      <div class="npf-progress">
        <div class="npf-times">
          <span id="npfCurrentTime">0:00</span>
          <span id="npfTotalTime">0:00</span>
        </div>
        <input id="npfSeek" class="npf-seek" type="range" min="0" max="100" value="0" />
      </div>

      <div class="npf-controls">
        <button id="npfPrev" class="npf-ctrl-btn">‚èÆ</button>
        <button id="npfPlayPause" class="npf-ctrl-btn main">‚ñ∂</button>
        <button id="npfNext" class="npf-ctrl-btn">‚è≠</button>
      </div>
    </div>
  </div>


  <!-- Supabase client -->
  <script type="module" src="/js/supabaseClient.js"></script>

  <!-- App logic (unchanged from your version) -->
  <script type="module">
    const supabase = window.supabase;
    const $ = (id) => document.getElementById(id);

    const authOverlay = $("authOverlay");
    const userChip = $("userChip");
    const globalMsg = $("globalMsg");
    const sidebarCredits = $("sidebarCredits");
    const btnSignOut = $("btnSignOut");
    const topTitle = $("topTitle");

    const feedEl = $("feed");
    const songsGrid = $("songsGrid");
    const copiesList = $("copiesList");
    const productGrid = $("productGrid");
    const profileCard = $("profileCard");
    const playerBar = $("playerBar");
    const nowPlaying = $("nowPlaying");
    const nowPlayingCover = $("nowPlayingCover");
    const nowPlayingTitle = $("nowPlayingTitle");
    const nowPlayingArtist = $("nowPlayingArtist");
    const nowPlayingStreams = $("nowPlayingStreams");
    const nowPlayingFull = $("nowPlayingFull");
    const npfClose = $("npfClose");
    const npfCover = $("npfCover");
    const npfTitle = $("npfTitle");
    const npfArtist = $("npfArtist");
    const npfStreams = $("npfStreams");
    const npfSeek = $("npfSeek");
    const npfCurrentTime = $("npfCurrentTime");
    const npfTotalTime = $("npfTotalTime");
    const npfPrev = $("npfPrev");
    const npfNext = $("npfNext");
    const npfPlayPause = $("npfPlayPause");
    const audioPlayer = $("audioPlayer");
    const playerTitle = $("playerTitle");
    const playerArtist = $("playerArtist");
    const playerCover = $("playerCover");
    const playerPrev = $("playerPrev");
    const playerNext = $("playerNext");
    const playerPlayPause = $("playerPlayPause");
    const playerReplay = $("playerReplay");

    let currentSession = null;
    let currentUserRow = null;
    let songsById = new Map();
    let songsData = [];           // full list in order for next/prev
    let currentSongIndex = null;  // index in songsData

    // streaming tracking
    let currentPlayingSongId = null;
    let streamReportedForCurrentPlay = false;


    function showGlobalMsg(text, kind = "") {
      globalMsg.textContent = text || "";
      globalMsg.className = "msg" + (kind ? " " + kind : "");
    }

    function setView(view) {
      document.querySelectorAll("section.view").forEach(sec => {
        sec.classList.toggle("active", sec.id === "view-" + view);
      });
      document.querySelectorAll(".nav-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.view === view);
      });
      const labelMap = { home: "Home", songs: "Songs", shop: "Shop", profile: "Profile" };
      topTitle.textContent = labelMap[view] || "iseehalo";
    }

    function initNav() {
      document.querySelectorAll(".nav-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const v = btn.dataset.view;
          setView(v);
        });
      });
    }
function startPlayingSong(song) {
  if (!song || !song.audio_url) return;

  currentPlayingSongId = song.id;
  streamReportedForCurrentPlay = false;

  // update full-screen UI
  applySongToUI(song);

  // show full-screen Now Playing
  nowPlayingFull.style.display = "flex";

  // load & play audio (audio element can stay in the hidden bar)
  audioPlayer.src = song.audio_url;

  audioPlayer
    .play()
    .then(() => {
      npfPlayPause.textContent = "‚è∏";
    })
    .catch((err) => console.error("Audio play failed:", err));
}

function startPlayingSongByIndex(index) {
  if (!songsData || index < 0 || index >= songsData.length) return;
  currentSongIndex = index;
  const song = songsData[index];
  startPlayingSong(song);
}



    async function registerStreamPlay(songId) {
      if (!songId) return;

      try {
        const { error } = await supabase.rpc("increment_stream", {
          song_uuid: songId,
        });
        if (error) {
          console.error("increment_stream RPC error:", error);
          return;
        }

        // Update local cache
        const song = songsById.get(songId);
        if (song) {
          song.stream_count = (song.stream_count || 0) + 1;
          songsById.set(songId, song);

          // Also update songsData array
          const idx = songsData.findIndex((s) => s.id === songId);
          if (idx !== -1) {
            songsData[idx].stream_count = song.stream_count;
          }

          // Update text in Songs grid
          const streamsEl = document.querySelector(
            `.song-card[data-song-id="${songId}"] .song-streams`
          );
          if (streamsEl) {
            streamsEl.textContent = `${song.stream_count} streams`;
          }

          // If this is the currently playing song, update the Now Playing panel too
          if (currentPlayingSongId === songId) {
            nowPlayingStreams.textContent = `${song.stream_count} streams`;
            applySongToUI(song);
          }

        }
      } catch (err) {
        console.error("increment_stream RPC failed:", err);
      }
    }

    function formatTime(sec) {
  if (!sec || isNaN(sec)) return "0:00";
  const s = Math.floor(sec);
  const m = Math.floor(s / 60);
  const r = s % 60;
  return `${m}:${r.toString().padStart(2, "0")}`;
}

function applySongToUI(song) {
  const title = song.title || "Untitled";
  const artist = song.artist || "Unknown artist";
  const cover = song.cover_url || "";
  const streamsText = `${song.stream_count || 0} streams`;

  // full-screen view
  npfTitle.textContent = title;
  npfArtist.textContent = artist;
  npfStreams.textContent = streamsText;
  npfCover.src = cover || "";
}



        function initPlayer() {
  // stream tracking + progress bar
  audioPlayer.addEventListener("timeupdate", () => {
    // 10s stream credit
    if (
      currentPlayingSongId &&
      !streamReportedForCurrentPlay &&
      audioPlayer.currentTime >= 10
    ) {
      streamReportedForCurrentPlay = true;
      registerStreamPlay(currentPlayingSongId);
    }

    // update time + slider
    const dur = audioPlayer.duration || 0;
    const cur = audioPlayer.currentTime || 0;
    npfCurrentTime.textContent = formatTime(cur);
    npfTotalTime.textContent = formatTime(dur);
    if (dur > 0) {
      npfSeek.value = (cur / dur) * 100;
    } else {
      npfSeek.value = 0;
    }
  });

  // seek from slider
  npfSeek.addEventListener("input", () => {
    const dur = audioPlayer.duration || 0;
    if (!dur) return;
    const pct = Number(npfSeek.value || 0) / 100;
    audioPlayer.currentTime = dur * pct;
  });

  // prev / next / replay-style controls
  npfPrev.addEventListener("click", () => {
    if (currentSongIndex == null) return;
    const prevIndex = currentSongIndex > 0 ? currentSongIndex - 1 : null;
    if (prevIndex == null) return;
    startPlayingSongByIndex(prevIndex);
  });

  npfNext.addEventListener("click", () => {
    if (currentSongIndex == null) return;
    const nextIndex =
      currentSongIndex < songsData.length - 1 ? currentSongIndex + 1 : null;
    if (nextIndex == null) return;
    startPlayingSongByIndex(nextIndex);
  });

  npfPlayPause.addEventListener("click", () => {
    if (!audioPlayer.src) return;
    if (audioPlayer.paused) {
      audioPlayer.play().then(() => {
        npfPlayPause.textContent = "‚è∏";
        playerPlayPause.textContent = "‚è∏";
      });
    } else {
      audioPlayer.pause();
      npfPlayPause.textContent = "‚ñ∂";
      playerPlayPause.textContent = "‚ñ∂";
    }
  });

  // keep full-screen + bar icons in sync with actual audio state
  audioPlayer.addEventListener("play", () => {
    npfPlayPause.textContent = "‚è∏";
    playerPlayPause.textContent = "‚è∏";
  });
  audioPlayer.addEventListener("pause", () => {
    npfPlayPause.textContent = "‚ñ∂";
    playerPlayPause.textContent = "‚ñ∂";
  });

  // close full-screen
  npfClose.addEventListener("click", () => {
    nowPlayingFull.style.display = "none";
  });
}



    async function loadProfile(user) {
  // 1) Load base user info
  const { data, error } = await supabase
    .from("users")
    .select("email, username, credits, total_earned, profile_picture, bio, is_premium")
    .eq("id", user.id)
    .maybeSingle();

  if (error) {
    console.error("Profile load error:", error);
    showGlobalMsg("Could not load profile.", "error");
    return;
  }
  currentUserRow = data;

  // 2) Load all purchased copies (grouped by song)
  const { data: copiesRaw, error: copiesErr } = await supabase
    .from("song_copies")
    .select("song_id")
    .eq("owner", user.id);

  if (copiesErr) {
    console.error("Purchased copies load error:", copiesErr);
  }

  const copiesBySong = new Map();
  (copiesRaw || []).forEach((c) => {
    const prev = copiesBySong.get(c.song_id) || 0;
    copiesBySong.set(c.song_id, prev + 1);
  });

  const purchasedCopiesCount = copiesRaw ? copiesRaw.length : 0;
  const purchasedSongIds = [...copiesBySong.keys()];

  let purchasedSongs = [];
  if (purchasedSongIds.length > 0) {
    const { data: copySongs, error: copySongsErr } = await supabase
      .from("songs")
      .select("id, title, artist, stream_count, cover_url")
      .in("id", purchasedSongIds);

    if (copySongsErr) {
      console.error("Songs for copies load error:", copySongsErr);
    } else {
      purchasedSongs = copySongs.map((s) => {
        const copiesOwned = copiesBySong.get(s.id) || 0;
        const streams = s.stream_count || 0;
        // 0.25 credits per stream per copy
        const estEarnings = streams * 0.25 * copiesOwned;
        return { ...s, copiesOwned, estEarnings };
      });
    }
  }

  // 3) Load uploaded songs
  const { data: uploadedSongs, error: uploadsErr } = await supabase
    .from("songs")
    .select("id, title, artist, stream_count, cover_url, created_at")
    .eq("creator_id", user.id)
    .order("created_at", { ascending: false });

  if (uploadsErr) {
    console.error("Uploaded songs load error:", uploadsErr);
  }

  const uploadedCount = uploadedSongs ? uploadedSongs.length : 0;

  // Build HTML pieces for the lists
  const purchasedListHtml =
    purchasedSongs && purchasedSongs.length
      ? purchasedSongs
          .map((s) => {
            const coverStyle = s.cover_url
              ? `background-image:url('${s.cover_url}');`
              : "";
            return `
              <div class="profile-list-item">
                <div class="profile-list-cover" style="${coverStyle}"></div>
                <div class="profile-list-main">
                  <div class="profile-list-title">${s.title || "Untitled"}</div>
                  <div class="profile-list-sub">${s.artist || "Unknown artist"}</div>
                </div>
                <div class="profile-list-meta">
                  <div>${s.copiesOwned} copies</div>
                  <div>${s.estEarnings.toFixed(2)} credits earned</div>
                </div>
              </div>
            `;
          })
          .join("")
      : `<div class="profile-bio" style="margin-top:4px;">You haven't purchased any song copies yet.</div>`;

  const uploadedListHtml =
    uploadedSongs && uploadedSongs.length
      ? uploadedSongs
          .map((s) => {
            const coverStyle = s.cover_url
              ? `background-image:url('${s.cover_url}');`
              : "";
            const streams = s.stream_count || 0;
            // 0.5 credits per stream for creator
            const estCreatorEarn = streams * 0.5;
            return `
              <div class="profile-list-item">
                <div class="profile-list-cover" style="${coverStyle}"></div>
                <div class="profile-list-main">
                  <div class="profile-list-title">${s.title || "Untitled"}</div>
                  <div class="profile-list-sub">${s.artist || "Unknown artist"}</div>
                  <div class="profile-list-sub">${streams} streams</div>
                </div>
                <div class="profile-list-meta">
                  <div>${estCreatorEarn.toFixed(2)} credits earned</div>
                </div>
              </div>
            `;
          })
          .join("")
      : `<div class="profile-bio" style="margin-top:4px;">You haven't uploaded any songs yet.</div>`;

  // Avatar / header
  const initials = (data.username || data.email || "?")
    .split(" ")[0]
    .slice(0, 2)
    .toUpperCase();

  const avatarStyle = data.profile_picture
    ? `background-image:url('${data.profile_picture}');`
    : "";

  const premiumBadge = data.is_premium
    ? `<div class="badge-premium">
         <span class="dot"></span>
         Premium member
       </div>`
    : `<div class="badge-premium" style="opacity:.6;">
         <span class="dot" style="background:#555;"></span>
         Free tier
       </div>`;

  // 4) Render full profile card
  profileCard.innerHTML = `
    <div class="profile-header">
      <div class="profile-avatar" style="${avatarStyle}">
        ${avatarStyle ? "" : initials}
      </div>
      <div>
        <div class="profile-name">${data.username || "Unnamed user"}</div>
        <div class="profile-email">${data.email || ""}</div>
        ${premiumBadge}
      </div>
    </div>

    <div class="profile-stats">
      <div>
        <span>Total credits</span>
        <strong>${Number(data.credits ?? 0).toFixed(2)}</strong>
      </div>
      <div>
        <span>Purchased copies</span>
        <strong>${purchasedCopiesCount}</strong>
      </div>
      <div>
        <span>My uploaded songs</span>
        <strong>${uploadedCount}</strong>
      </div>
    </div>

    <div class="profile-bio">
      ${data.bio || "No bio yet. You can manage your profile from the mobile app."}
    </div>

    <div class="profile-actions">
      <button class="btn-outline accent" onclick="window.location.href='/dashboard'">
        Manage subscription
      </button>
      <button class="btn-outline" onclick="alert('Profile editing coming soon to the web. You can edit your profile in the mobile app for now.')">
        Edit profile
      </button>
    </div>

    <div class="profile-section-heading">Purchased copies</div>
    <div class="profile-list">
      ${purchasedListHtml}
    </div>

    <div class="profile-section-heading">My uploaded songs</div>
    <div class="profile-list">
      ${uploadedListHtml}
    </div>
  `;

  // Sidebar credits label
  sidebarCredits.textContent = "Credits: " + Number(data.credits ?? 0).toFixed(2);
}


        async function loadSongs() {
      songsGrid.innerHTML = "Loading songs‚Ä¶";

      const { data, error } = await supabase
        .from("songs")
        .select("id, title, artist, audio_url, cover_url, stream_count, created_at")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Load songs error:", error);
        songsGrid.textContent = "Could not load songs.";
        return;
      }

      songsById.clear();
      songsData = data || [];
      songsData.forEach((s) => songsById.set(s.id, s));

      if (!songsData.length) {
        songsGrid.textContent = "No songs yet.";
        return;
      }

      songsGrid.innerHTML = "";
      songsData.forEach((song, index) => {
        const card = document.createElement("div");
        card.className = "song-card";
        card.dataset.songId = song.id;

        const coverStyle = song.cover_url
          ? `background-image:url('${song.cover_url}');`
          : "";

        card.innerHTML = `
          <div class="song-cover" style="${coverStyle}"></div>
          <div class="song-meta">
            <div>
              <div class="song-title">${song.title || "Untitled"}</div>
              <div class="song-artist">${song.artist || "Unknown artist"}</div>
              <div class="song-streams">${song.stream_count || 0} streams</div>
            </div>
            <button class="song-play-btn">Play</button>
          </div>
        `;

        card.querySelector(".song-play-btn").addEventListener("click", () => {
          startPlayingSongByIndex(index);
        });

        songsGrid.appendChild(card);
      });
    }


    async function loadFeed() {
      feedEl.innerHTML = "Loading feed‚Ä¶";

      const { data, error } = await supabase
        .from("posts")
        .select("id, user_id, caption, created_at, media_url, media_type, song_id")
        .order("created_at", { ascending: false })
        .limit(30);

      if (error) {
        console.error("Feed error:", error);
        feedEl.textContent = "Could not load feed.";
        return;
      }

      if (!data.length) {
        feedEl.textContent = "No posts yet.";
        return;
      }

      feedEl.innerHTML = "";
      data.forEach(post => {
        const div = document.createElement("div");
        div.className = "card";

        const created = new Date(post.created_at);
        const dateStr = created.toLocaleDateString();

        const avatarText = (post.user_id || "U").slice(0, 2).toUpperCase();

        let mediaHtml = "";
        if (post.media_url) {
          if (post.media_type === "video") {
            mediaHtml = `<video src="${post.media_url}" style="width:100%;border-radius:10px;margin-top:6px;" controls muted></video>`;
          } else {
            mediaHtml = `<img src="${post.media_url}" alt="" style="width:100%;border-radius:10px;margin-top:6px;object-fit:cover;max-height:260px;" />`;
          }
        }

        let songTagHtml = "";
        const song = post.song_id ? songsById.get(post.song_id) : null;
        if (song) {
          songTagHtml = `
            <div class="post-tag-song">
              üéµ ${song.title || "Untitled"} ‚Äì ${song.artist || "Unknown artist"}
              <button class="btn-mini" data-song-id="${song.id}" style="margin-left:6px;">Play</button>
            </div>
          `;
        }

        div.innerHTML = `
          <div class="post-header">
            <div class="avatar">${avatarText}</div>
            <div class="post-meta">
              <div>User ${post.user_id?.slice(0,8) || "unknown"}</div>
              <div>${dateStr}</div>
            </div>
          </div>
          <div class="post-caption">${post.caption || ""}</div>
          ${mediaHtml}
          ${songTagHtml}
        `;

        if (song) {
          const btn = div.querySelector("button[data-song-id]");
          if (btn) {
            btn.addEventListener("click", () => startPlayingSong(song));
          }
        }

        feedEl.appendChild(div);
      });
    }

    async function loadShop() {
      copiesList.innerHTML = "Loading song copies‚Ä¶";

      const { data: copies, error: copiesErr } = await supabase
        .from("song_copies")
        .select("id, song_id, listing_price, is_listed, created_at, owner")
        .eq("is_listed", true)
        .order("created_at", { ascending: false })
        .limit(50);

      if (copiesErr) {
        console.error("Copies error:", copiesErr);
        copiesList.textContent = "Could not load song copies.";
      } else if (!copies.length) {
        copiesList.textContent = "No song copies listed yet.";
      } else {
        copiesList.innerHTML = "";
        copies.forEach(copy => {
          const song = songsById.get(copy.song_id);
          const div = document.createElement("div");
          div.className = "copy-card";

          const title = song?.title || "Untitled";
          const artist = song?.artist || "Unknown artist";

          div.innerHTML = `
            <div class="copy-song">${title}</div>
            <div class="copy-meta">${artist}</div>
            <div class="copy-meta">Price: <strong>${copy.listing_price ?? 0} credits</strong></div>
            <button class="copy-cta disabled">Buy (web coming soon)</button>
          `;
          copiesList.appendChild(div);
        });
      }

      productGrid.innerHTML = "Loading products‚Ä¶";

      const { data: products, error: productsErr } = await supabase
        .from("products")
        .select("id, name, description, price_cents, in_stock, image_url")
        .eq("in_stock", true)
        .order("created_at", { ascending: false });

      if (productsErr) {
        console.error("Products error:", productsErr);
        productGrid.textContent = "Could not load products.";
        return;
      }

      if (!products.length) {
        productGrid.textContent = "No products available.";
        return;
      }

      productGrid.innerHTML = "";
      products.forEach(p => {
        const card = document.createElement("div");
        card.className = "product-card";

        const imgUrl = p.image_url || "";

        card.innerHTML = `
          ${imgUrl ? `<img src="${imgUrl}" alt="${p.name}" class="product-thumb" />` : `<div class="product-thumb"></div>`}
          <div class="product-name">${p.name}</div>
          <div style="font-size:12px;color:var(--muted);margin-top:2px;">${p.description || ""}</div>
          <div class="product-price" style="margin-top:4px;">${p.price_cents ?? 0} credits</div>
          <button class="product-cta disabled">Buy (web coming soon)</button>
        `;

        productGrid.appendChild(card);
      });
    }

    async function loadEverything(user) {
      showGlobalMsg("Loading your data‚Ä¶");
      await Promise.all([
        loadProfile(user),
        loadSongs(),
      ]);
      await Promise.all([
        loadFeed(),
        loadShop(),
      ]);
      showGlobalMsg("");
    }

    async function initAuth() {
      const { data, error } = await supabase.auth.getSession();
      if (error) {
        console.error("Auth session error:", error);
        authOverlay.style.display = "flex";
        return null;
      }
      const session = data?.session || null;

      if (!session) {
        authOverlay.style.display = "flex";
        return null;
      }

      authOverlay.style.display = "none";
      currentSession = session;

      const user = session.user;
      userChip.innerHTML = `Signed in as <strong>${user.email}</strong>`;

      return user;
    }

    async function initApp() {
      initNav();
      initPlayer();

      const user = await initAuth();
      if (!user) return;

      await loadEverything(user);

      btnSignOut.addEventListener("click", async () => {
        await supabase.auth.signOut();
        location.href = "/auth.html";
      });

      supabase.auth.onAuthStateChange(async (_event, session) => {
        if (!session) {
          authOverlay.style.display = "flex";
        } else {
          authOverlay.style.display = "none";
          currentSession = session;
          userChip.innerHTML = `Signed in as <strong>${session.user.email}</strong>`;
          await loadEverything(session.user);
        }
      });
    }

    initApp();
  </script>
</body>
</html>

