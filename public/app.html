<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>iseehalo — Web app</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #000000;
      --bg-elevated: #0f0f0f;
      --bg-card: #111111;
      --accent: #1db954;
      --halo: #fff59e;
      --muted: #aaaaaa;
      --border: #202020;
      --danger: #ff6b6b;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #202020 0, #000 45%);
      color: #ffffff;
      font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .shell {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Top bar */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 18px;
      border-bottom: 1px solid #151515;
      background: rgba(0,0,0,0.92);
      backdrop-filter: blur(10px);
    }
    .brand {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .isee { color: #fff; }
    .halo { color: var(--halo); }

    .pill-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
    }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #111;
      border: 1px solid #222;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .pill-label { color: var(--muted); font-size: 11px; text-transform: uppercase; }
    .pill-value { font-weight: 600; }

    .user-email {
      font-size: 13px;
      color: var(--muted);
    }
    .link {
      color: var(--accent);
      text-decoration: none;
      font-size: 13px;
      cursor: pointer;
    }
    .link:hover { text-decoration: underline; }

    /* Layout */
    .main {
      flex: 1;
      display: grid;
      grid-template-columns: 220px minmax(0, 1fr);
      min-height: 0;
    }

    @media (max-width: 768px) {
      .main {
        grid-template-columns: 1fr;
      }
      .sidebar {
        flex-direction: row;
        border-right: none;
        border-bottom: 1px solid #151515;
        padding: 8px 10px;
        overflow-x: auto;
      }
      .sidebar button {
        flex: 1;
        text-align: center;
      }
    }

    .sidebar {
      background: #050505;
      border-right: 1px solid #151515;
      padding: 14px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav-btn {
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 8px 14px;
      text-align: left;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.15s ease, color 0.15s ease;
    }

    .nav-btn-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: transparent;
    }

    .nav-btn.active {
      background: #161616;
      color: #fff;
    }
    .nav-btn.active .nav-btn-dot {
      background: var(--accent);
    }

    .content {
      padding: 18px;
      overflow-y: auto;
    }

    h1 {
      margin: 0 0 6px;
      font-size: 22px;
    }

    .subhead {
      margin: 0 0 16px;
      color: var(--muted);
      font-size: 14px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 14px;
      border: 1px solid #191919;
      padding: 14px 16px;
      margin-bottom: 16px;
    }

    .error-text {
      color: var(--danger);
      font-size: 14px;
    }

    .feed-empty {
      color: var(--muted);
      font-size: 14px;
    }

    /* Feed posts */
    .post {
      display: grid;
      grid-template-columns: 56px minmax(0, 1fr);
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid #181818;
    }
    .post:last-child { border-bottom: none; }

    .post-avatar {
      width: 48px;
      height: 48px;
      border-radius: 999px;
      background-position: center;
      background-size: cover;
      background-color: #333;
    }

    .post-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 6px;
    }
    .post-name {
      font-weight: 600;
      font-size: 14px;
    }
    .post-time {
      font-size: 11px;
      color: var(--muted);
    }
    .post-caption {
      font-size: 14px;
      margin-top: 4px;
    }
    .post-media {
      margin-top: 8px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #222;
      max-height: 280px;
    }
    .post-media img,
    .post-media video {
      width: 100%;
      display: block;
      object-fit: cover;
    }

    /* Songs */
    .songs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
    }
    .song-card {
      display: grid;
      grid-template-columns: 72px minmax(0, 1fr);
      gap: 10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid #1c1c1c;
      background: #101010;
      font-size: 13px;
    }
    .song-cover {
      width: 72px;
      height: 72px;
      border-radius: 12px;
      background-position: center;
      background-size: cover;
      background-color: #333;
    }
    .song-title {
      font-weight: 600;
      font-size: 14px;
    }
    .song-artist {
      color: var(--muted);
      font-size: 13px;
    }
    .song-meta {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }
    .song-bottom {
      margin-top: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
    }
    .song-price {
      font-weight: 600;
    }
    .song-btn {
      border-radius: 999px;
      border: none;
      background: #fff;
      color: #000;
      font-size: 12px;
      padding: 5px 10px;
      cursor: pointer;
    }
    .song-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    /* Shop */
    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }
    .product-card {
      background: #101010;
      border-radius: 14px;
      border: 1px solid #1c1c1c;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }
    .product-image {
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 6px;
      max-height: 150px;
      border: 1px solid #222;
    }
    .product-image img {
      width: 100%;
      display: block;
      object-fit: cover;
    }
    .product-name {
      font-weight: 600;
      font-size: 14px;
    }
    .product-description {
      color: var(--muted);
      font-size: 13px;
    }
    .product-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
    }
    .price {
      font-weight: 600;
    }
    .small-btn {
      border-radius: 999px;
      border: none;
      background: #fff;
      color: #000;
      font-size: 12px;
      padding: 5px 10px;
      cursor: pointer;
    }
    .small-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    /* Profile */
    .profile-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .profile-avatar {
      width: 72px;
      height: 72px;
      border-radius: 999px;
      background-position: center;
      background-size: cover;
      background-color: #333;
      border: 2px solid #2c2c2c;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #111;
      border: 1px solid #222;
      font-size: 11px;
    }
    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 12px;
      font-size: 13px;
    }
    .stat-card {
      background: #101010;
      border-radius: 12px;
      border: 1px solid #1b1b1b;
      padding: 10px 12px;
    }
    .stat-label {
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .stat-value {
      font-weight: 600;
      font-size: 15px;
    }

    .section-title {
      font-size: 14px;
      color: var(--muted);
      margin: 14px 0 6px;
    }
    .list-plain {
      margin: 0;
      padding-left: 14px;
      font-size: 13px;
      color: var(--muted);
    }
  </style>
</head>
<body>
<div class="shell">
  <header class="topbar">
    <div class="brand">
      <span class="isee">isee</span><span class="halo">halo</span>
    </div>
    <div class="pill-row">
      <div class="pill">
        <span class="pill-label">Credits</span>
        <span class="pill-value" id="navCredits">0</span>
      </div>
      <div class="pill">
        <span class="pill-label">Plan</span>
        <span class="pill-value" id="navPlan">Free</span>
      </div>
      <span class="user-email" id="navEmail"></span>
      <a class="link" href="#" id="signOutLink">Sign out</a>
    </div>
  </header>

  <div class="main">
    <aside class="sidebar">
      <button class="nav-btn active" data-view="home">
        <span class="nav-btn-dot"></span> Home
      </button>
      <button class="nav-btn" data-view="songs">
        <span class="nav-btn-dot"></span> Songs
      </button>
      <button class="nav-btn" data-view="shop">
        <span class="nav-btn-dot"></span> Shop
      </button>
      <button class="nav-btn" data-view="profile">
        <span class="nav-btn-dot"></span> Profile
      </button>
    </aside>

    <main class="content">
      <!-- HOME -->
      <section id="view-home">
        <h1>Home</h1>
        <p class="subhead">See what artists and fans are sharing on iseehalo.</p>
        <div class="card">
          <div id="feedError" class="error-text" style="display:none;"></div>
          <div id="feedList"></div>
        </div>
      </section>

      <!-- SONGS -->
      <section id="view-songs" style="display:none;">
        <h1>Songs</h1>
        <p class="subhead">Browse limited songs, stream, and see remaining copies.</p>
        <div class="card">
          <div id="songsError" class="error-text" style="display:none;"></div>
          <div id="songsGrid" class="songs-grid"></div>
        </div>
      </section>

      <!-- SHOP -->
      <section id="view-shop" style="display:none;">
        <h1>Shop</h1>
        <p class="subhead">Spend your credits on limited products and rewards.</p>
        <div class="card">
          <div id="shopError" class="error-text" style="display:none;"></div>
          <div id="shopGrid" class="shop-grid"></div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="view-profile" style="display:none;">
        <h1>Profile</h1>
        <p class="subhead">Manage your account, credits, and music activity.</p>
        <div class="card">
          <div class="profile-row">
            <div id="profileAvatar" class="profile-avatar"></div>
            <div>
              <div id="profileName" style="font-weight:600;font-size:16px;">Your name</div>
              <div id="profileEmail" style="font-size:13px;color:var(--muted);"></div>
              <div id="profilePlanBadge" class="badge" style="margin-top:6px;">
                <span class="badge-dot"></span> <span id="profilePlanText">Free plan</span>
              </div>
            </div>
          </div>

          <div id="profileBio" style="margin-top:10px;font-size:13px;color:var(--muted);"></div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Credits</div>
              <div class="stat-value" id="profileCredits">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total earned</div>
              <div class="stat-value" id="profileEarned">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">My copies</div>
              <div class="stat-value" id="profileCopies">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">My uploads</div>
              <div class="stat-value" id="profileUploads">0</div>
            </div>
          </div>

          <div class="section-title">Tips</div>
          <ul class="list-plain">
            <li>Earn credits when people stream songs you created or copies you own.</li>
            <li>Use credits in the Shop for exclusive items.</li>
            <li>Upgrade to Premium in the main site for enhanced perks.</li>
          </ul>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- Supabase client (global window.supabase) -->
<script type="module" src="/js/supabaseClient.js"></script>
<script type="module">
  const navCredits = document.getElementById("navCredits");
  const navPlan = document.getElementById("navPlan");
  const navEmail = document.getElementById("navEmail");
  const signOutLink = document.getElementById("signOutLink");

  const feedError = document.getElementById("feedError");
  const feedList = document.getElementById("feedList");

  const songsError = document.getElementById("songsError");
  const songsGrid = document.getElementById("songsGrid");

  const shopError = document.getElementById("shopError");
  const shopGrid = document.getElementById("shopGrid");

  const profileAvatar = document.getElementById("profileAvatar");
  const profileName = document.getElementById("profileName");
  const profileEmail = document.getElementById("profileEmail");
  const profilePlanText = document.getElementById("profilePlanText");
  const profileCredits = document.getElementById("profileCredits");
  const profileEarned = document.getElementById("profileEarned");
  const profileCopies = document.getElementById("profileCopies");
  const profileUploads = document.getElementById("profileUploads");
  const profileBio = document.getElementById("profileBio");

  function showError(elem, msg) {
    elem.style.display = "block";
    elem.textContent = msg;
  }
  function clearError(elem) {
    elem.style.display = "none";
    elem.textContent = "";
  }

  function formatDate(ts) {
    if (!ts) return "";
    const d = new Date(ts);
    return d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
  }

  // copy price logic – mirror get_copy_price() in SQL
  function computeCopyPrice(streamCount) {
    const s = streamCount || 0;
    if (s < 50) return 5;
    if (s < 200) return 10;
    return 20;
  }

  // ---- NAV ----
  const navButtons = document.querySelectorAll(".nav-btn");
  navButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const view = btn.dataset.view;
      navButtons.forEach(b => b.classList.toggle("active", b === btn));
      document.querySelectorAll("main section").forEach(sec => {
        sec.style.display = sec.id === "view-" + view ? "block" : "none";
      });
    });
  });

  // ---- PROFILE ----
  async function loadProfile(userId, email) {
    try {
      const { data, error } = await window.supabase
        .from("users")
        .select("username, profile_picture, bio, credits, total_earned, is_premium")
        .eq("id", userId)
        .maybeSingle();

      if (error) {
        console.error("profile error:", error);
        return;
      }

      const row = data || {};
      const name = row.username || email || "iseehalo user";

      profileName.textContent = name;
      profileEmail.textContent = email || "";
      profileCredits.textContent = row.credits ?? 0;
      profileEarned.textContent = row.total_earned ?? 0;
      profileBio.textContent = row.bio || "";

      const avatarUrl = row.profile_picture;
      if (avatarUrl) profileAvatar.style.backgroundImage = `url("${avatarUrl}")`;
      else profileAvatar.style.backgroundImage = "none";

      const premium = row.is_premium === true;
      profilePlanText.textContent = premium ? "Premium plan" : "Free plan";
      navPlan.textContent = premium ? "Premium" : "Free";
      navCredits.textContent = row.credits ?? 0;
    } catch (err) {
      console.error("loadProfile exception:", err);
    }

    // copies count
    try {
      const { count } = await window.supabase
        .from("song_copies")
        .select("id", { head: true, count: "exact" })
        .eq("owner", userId);
      profileCopies.textContent = count ?? 0;
    } catch (err) {
      console.error("copies count error:", err);
    }

    // uploads count
    try {
      const { count } = await window.supabase
        .from("songs")
        .select("id", { head: true, count: "exact" })
        .eq("creator_id", userId);
      profileUploads.textContent = count ?? 0;
    } catch (err) {
      console.error("uploads count error:", err);
    }
  }

  // ---- FEED ----
  async function loadFeed() {
    clearError(feedError);
    feedList.innerHTML = "Loading feed…";

    try {
      const { data, error } = await window.supabase
        .from("posts")
        .select(`
          id,
          caption,
          media_url,
          media_type,
          created_at,
          user_id,
          users!posts_user_id_fkey (
            username,
            profile_picture
          )
        `)
        .order("created_at", { ascending: false })
        .limit(40);

      if (error) {
        console.error("feed error:", error);
        showError(feedError, error.message || "Could not load feed.");
        feedList.innerHTML = "";
        return;
      }

      const posts = data || [];
      if (!posts.length) {
        feedList.innerHTML = '<div class="feed-empty">No posts yet. When artists share, they’ll appear here.</div>';
        return;
      }

      feedList.innerHTML = "";
      posts.forEach(post => {
        const wrap = document.createElement("div");
        wrap.className = "post";

        const user = post.users || {};
        const displayName = user.username || "Anon user";
        const avatarUrl = user.profile_picture || "";

        const avatar = document.createElement("div");
        avatar.className = "post-avatar";
        if (avatarUrl) avatar.style.backgroundImage = `url("${avatarUrl}")`;

        const right = document.createElement("div");
        const header = document.createElement("div");
        header.className = "post-header";

        const nameEl = document.createElement("div");
        nameEl.className = "post-name";
        nameEl.textContent = displayName;

        const timeEl = document.createElement("div");
        timeEl.className = "post-time";
        timeEl.textContent = formatDate(post.created_at);

        header.appendChild(nameEl);
        header.appendChild(timeEl);

        const captionEl = document.createElement("div");
        captionEl.className = "post-caption";
        captionEl.textContent = post.caption || "";

        right.appendChild(header);
        right.appendChild(captionEl);

        if (post.media_url) {
          const mediaWrap = document.createElement("div");
          mediaWrap.className = "post-media";

          if (post.media_type === "video") {
            const vid = document.createElement("video");
            vid.src = post.media_url;
            vid.controls = true;
            mediaWrap.appendChild(vid);
          } else {
            const img = document.createElement("img");
            img.src = post.media_url;
            img.alt = "";
            mediaWrap.appendChild(img);
          }
          right.appendChild(mediaWrap);
        }

        wrap.appendChild(avatar);
        wrap.appendChild(right);
        feedList.appendChild(wrap);
      });
    } catch (err) {
      console.error("feed exception:", err);
      showError(feedError, err.message || String(err) || "Could not load feed.");
      feedList.innerHTML = "";
    }
  }

  // ---- SONGS ----
  async function loadSongs() {
    clearError(songsError);
    songsGrid.innerHTML = "Loading songs…";

    try {
      // Prefer the view if it exists
      let res = await window.supabase
        .from("songs_with_remaining")
        .select("id, title, artist, cover_url, stream_count, remaining_copies")
        .order("created_at", { ascending: false });

      // If the view doesn't exist, fall back to songs table
      if (res.error && /relation .* does not exist/i.test(res.error.message)) {
        res = await window.supabase
          .from("songs")
          .select("id, title, artist, cover_url, stream_count")
          .order("created_at", { ascending: false });
      }

      const { data, error } = res;
      if (error) {
        console.error("songs error:", error);
        showError(songsError, error.message || "Could not load songs.");
        songsGrid.innerHTML = "";
        return;
      }

      const songs = data || [];
      if (!songs.length) {
        songsGrid.innerHTML = '<div class="feed-empty">No songs have been uploaded yet.</div>';
        return;
      }

      songsGrid.innerHTML = "";
      songs.forEach(s => {
        const card = document.createElement("div");
        card.className = "song-card";

        const cover = document.createElement("div");
        cover.className = "song-cover";
        if (s.cover_url) cover.style.backgroundImage = `url("${s.cover_url}")`;

        const right = document.createElement("div");

        const title = document.createElement("div");
        title.className = "song-title";
        title.textContent = s.title || "Untitled track";

        const artist = document.createElement("div");
        artist.className = "song-artist";
        artist.textContent = s.artist || "Unknown artist";

        const meta = document.createElement("div");
        meta.className = "song-meta";
        const remaining = typeof s.remaining_copies === "number"
          ? s.remaining_copies
          : null;
        meta.textContent =
          `Streams: ${s.stream_count ?? 0}` +
          (remaining !== null ? ` • Remaining copies: ${remaining}` : "");

        const bottom = document.createElement("div");
        bottom.className = "song-bottom";

        const priceEl = document.createElement("div");
        priceEl.className = "song-price";
        const price = computeCopyPrice(s.stream_count);
        priceEl.textContent = `${price} credits / copy`;

        const btn = document.createElement("button");
        btn.className = "song-btn";
        btn.textContent = "View";
        // Later you can hook this to open a song detail / player
        btn.addEventListener("click", () => {
          alert(`Song: ${s.title} — this is where a detail/player view would go.`);
        });

        bottom.appendChild(priceEl);
        bottom.appendChild(btn);

        right.appendChild(title);
        right.appendChild(artist);
        right.appendChild(meta);
        right.appendChild(bottom);

        card.appendChild(cover);
        card.appendChild(right);

        songsGrid.appendChild(card);
      });
    } catch (err) {
      console.error("songs exception:", err);
      showError(songsError, err.message || String(err) || "Could not load songs.");
      songsGrid.innerHTML = "";
    }
  }

  // ---- SHOP ----
  async function loadShop() {
    clearError(shopError);
    shopGrid.innerHTML = "Loading products…";

    try {
      const { data, error } = await window.supabase
        .from("products")
        .select("id, name, description, price_cents, in_stock, image_url")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("shop error:", error);
        showError(shopError, error.message || "Could not load products.");
        shopGrid.innerHTML = "";
        return;
      }

      const items = data || [];
      if (!items.length) {
        shopGrid.innerHTML = '<div class="feed-empty">No products yet. Check back soon!</div>';
        return;
      }

      shopGrid.innerHTML = "";
      items.forEach(p => {
        const card = document.createElement("div");
        card.className = "product-card";

        if (p.image_url) {
          const imgWrap = document.createElement("div");
          imgWrap.className = "product-image";
          const img = document.createElement("img");
          img.src = p.image_url;
          img.alt = p.name || "";
          imgWrap.appendChild(img);
          card.appendChild(imgWrap);
        }

        const nameEl = document.createElement("div");
        nameEl.className = "product-name";
        nameEl.textContent = p.name;

        const descEl = document.createElement("div");
        descEl.className = "product-description";
        descEl.textContent = p.description;

        const bottom = document.createElement("div");
        bottom.className = "product-bottom";

        const price = document.createElement("div");
        price.className = "price";
        const cents = p.price_cents ?? 0;
        const credits = cents / 100;
        price.textContent = `${credits.toFixed(2)} credits`;

        const btn = document.createElement("button");
        btn.className = "small-btn";
        btn.textContent = p.in_stock === false ? "Out of stock" : "Redeem";
        btn.disabled = p.in_stock === false;
        // You can wire this to call buy_product() later

        bottom.appendChild(price);
        bottom.appendChild(btn);

        card.appendChild(nameEl);
        card.appendChild(descEl);
        card.appendChild(bottom);

        shopGrid.appendChild(card);
      });
    } catch (err) {
      console.error("shop exception:", err);
      showError(shopError, err.message || String(err) || "Could not load products.");
      shopGrid.innerHTML = "";
    }
  }

  // ---- AUTH + INIT ----
  async function init() {
    const { data, error } = await window.supabase.auth.getSession();
    if (error) {
      console.error("auth getSession error:", error);
    }
    const session = data?.session || null;
    if (!session) {
      window.location.href = "/auth.html?from=app";
      return;
    }

    const user = session.user;
    const userId = user.id;
    const email = user.email;

    navEmail.textContent = email || "";
    await loadProfile(userId, email);
    await loadFeed();
    await loadSongs();
    await loadShop();
  }

  signOutLink.addEventListener("click", async (e) => {
    e.preventDefault();
    try {
      await window.supabase.auth.signOut();
    } finally {
      window.location.href = "/auth.html";
    }
  });

  init();
</script>
</body>
</html>
