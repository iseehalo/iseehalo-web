<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iseehalo ‚Äî Dashboard</title>

  <!-- Supabase client -->
  <script type="module" src="/js/supabaseClient.js"></script>

  <style>
    :root {
      --isee: #ffffff;
      --halo: #f7e37c; /* pastel yellow */
      --bg: #111;
      --text: #f5f5f5;
      --accent: #f7e37c;
      --card: #1c1c1c;
      --border: #333;
      --danger: #ff5b5b;
    }
    body {
      font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      margin: 0;
      display: grid;
      place-items: center;
      padding: 24px;
      text-align: center;
    }
    h1 { font-size: 2rem; margin: 0 0 8px; }
    .halo { color: var(--halo); }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: min(560px, 92vw);
      padding: 24px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.35);
    }
    .muted { color: #bdbdbd; margin: 0 0 18px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    .btn {
      border: 0; border-radius: 10px; padding: 10px 14px; cursor: pointer;
      font-weight: 600; transition: transform .15s ease, opacity .15s ease;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn-accent { background: linear-gradient(90deg,#FFD700,#ffcc33); color: #000; }
    .btn-ghost { background: #272727; color: #fff; }
    .btn-danger { background: #2a1717; color: var(--danger); }
    .status-box {
      margin-top: 16px; padding: 14px; border-radius: 10px; font-size: 0.95rem;
    }
    .premium {
      background: rgba(247, 227, 124, 0.15);
      color: var(--halo);
    }
    .not-premium {
      background: rgba(255, 60, 60, 0.15);
      color: var(--danger);
    }
    .divider { height: 1px; background: var(--border); margin: 16px 0; }
    .userline { font-size: .95rem; margin: 6px 0; }
    a.link { color: var(--halo); text-decoration: none; }
    a.link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="card">
    <h1><span class="isee">isee</span><span class="halo">halo</span> Dashboard</h1>
    <p class="muted">Manage your subscription and account.</p>

    <div id="userBlock" class="userline">Loading account‚Ä¶</div>

    <div class="row" style="margin-top: 8px;">
      <button id="btnRefresh" class="btn btn-ghost">Refresh Status</button>
      <button id="btnBilling" class="btn btn-accent">Manage Billing</button>
      <button id="btnSignOut" class="btn btn-danger">Sign out</button>
    </div>

    <div id="result" class="status-box" style="display:none;"></div>

    <div class="divider"></div>
    <p class="muted">Need to subscribe? Go to the <a class="link" href="/">upgrade page</a>.</p>
  </div>

  <!-- Load Supabase UMD library (must come before supabaseClient.js) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<!-- Initialize global client -->
  <script type="module">
    // 1. SMART URL: Detects if you're on Render or Localhost
    const BACKEND_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
      ? "http://localhost:3000"
      : "https://iseehalo-web.onrender.com"; // üëà Ensure this is your actual Render Backend URL

    const userBlock = document.getElementById("userBlock");
    const resultBox = document.getElementById("result");
    const btnRefresh = document.getElementById("btnRefresh");
    const btnBilling = document.getElementById("btnBilling");
    const btnSignOut = document.getElementById("btnSignOut");

    let currentEmail = null;

    function showStatus(text, ok) {
      resultBox.style.display = "block";
      resultBox.textContent = text;
      // 'ok' can be true, false, or null (for loading/errors)
      if (ok === true) resultBox.className = "status-box premium";
      else if (ok === false) resultBox.className = "status-box not-premium";
      else resultBox.className = "status-box";
    }

    async function ensureAuthed() {
      // Use the global window.supabase initialized by your client script
      const { data, error } = await window.supabase.auth.getUser();
      const user = data?.user;
      
      if (error || !user) {
        window.location.href = "/auth.html";
        return null;
      }
      
      currentEmail = user.email || null;
      userBlock.innerHTML = `Signed in as <strong>${currentEmail}</strong>`;
      return user;
    }

    async function loadStatus() {
      if (!currentEmail) return;
      showStatus("Checking status‚Ä¶", null);

      try {
        // Use BACKEND_URL instead of window.location.origin
        const res = await fetch(`${BACKEND_URL}/status?email=${encodeURIComponent(currentEmail)}`);
        
        if (!res.ok) throw new Error("Backend unreachable");
        
        const data = await res.json();

        if (!data.user || !data.user.is_premium) {
          showStatus("‚ö†Ô∏è Standard Account ‚Äî Upgrade to get Premium.", false);
        } else {
          // Format the date if it exists
          const dateStr = data.user.current_period_end 
            ? new Date(data.user.current_period_end).toLocaleDateString()
            : "Active";
          showStatus(`üåü Premium active ‚Äî renews on ${dateStr}`, true);
        }
      } catch (err) {
        console.error("Dashboard Fetch Error:", err);
        showStatus("Error checking status. Please try again.", false);
      }
    }

    // Portals use POST, so use BACKEND_URL here too
    async function openBilling() {
      if (!currentEmail) return alert("Please sign in again.");
      try {
        const res = await fetch(`${BACKEND_URL}/create-portal-session`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: currentEmail }),
        });
        const data = await res.json();
        if (data.url) window.location.href = data.url;
        else alert(data.error || "Unable to open billing portal.");
      } catch (err) {
        alert("Error opening billing portal.");
      }
    }

    async function signOut() {
      await window.supabase.auth.signOut();
      window.location.href = "/auth.html";
    }

    // Initialize
    const user = await ensureAuthed();
    if (user) {
        loadStatus();
        btnRefresh.onclick = loadStatus;
        btnBilling.onclick = openBilling;
        btnSignOut.onclick = signOut;
    }
</script>
</body>
</html>


