<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>iseehalo â€” Waitlist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --halo: #fff59e;
        --accent: #1db954;
        --bg: #000;
        --card: #0f0f0f;
        --text: #ffffff;
        --muted: #aaaaaa;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto,
          Arial, sans-serif;
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, #222 0, #000 45%);
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }

      .container {
        width: 100%;
        max-width: 900px;
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
        gap: 24px;
        align-items: stretch;
      }

      @media (max-width: 780px) {
        .container {
          grid-template-columns: 1fr;
        }
      }

      .hero {
        padding: 24px 20px;
      }

      .brand {
        font-size: 32px;
        font-weight: 700;
        letter-spacing: -0.5px;
        margin-bottom: 8px;
      }

      .isee {
        color: #fff;
      }

      .halo {
        color: var(--halo);
      }

      .tagline {
        font-size: 18px;
        color: var(--muted);
        margin-bottom: 16px;
      }

      .highlight {
        color: var(--accent);
        font-weight: 600;
      }

      .bullets {
        list-style: none;
        padding-left: 0;
        margin: 0 0 20px;
        color: var(--muted);
        font-size: 14px;
      }

      .bullets li::before {
        content: "â€¢ ";
        color: var(--halo);
      }

      .small-note {
        font-size: 13px;
        color: var(--muted);
      }

      .card {
        background: var(--card);
        border-radius: 16px;
        padding: 20px 18px;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.5);
      }

      h2 {
        margin-top: 0;
        font-size: 20px;
        margin-bottom: 8px;
      }

      label {
        display: block;
        font-size: 13px;
        color: #c5c5c5;
        margin: 10px 0 5px;
      }

      input {
        width: 100%;
        padding: 11px 12px;
        border-radius: 10px;
        border: 1px solid #222;
        background: #121212;
        color: #fff;
        outline: none;
        font-size: 14px;
      }

      input:focus {
        border-color: #343434;
      }

      button {
        width: 100%;
        margin-top: 14px;
        padding: 11px 12px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 15px;
        background: linear-gradient(90deg, #ffd700, #ffcc33);
        color: #000;
        transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.2s;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 18px rgba(255, 215, 0, 0.35);
      }

      button:disabled {
        opacity: 0.6;
        cursor: default;
        transform: none;
        box-shadow: none;
      }

      .msg {
        margin-top: 10px;
        font-size: 13px;
        min-height: 18px;
      }

      .msg.success {
        color: #8ef18e;
      }
      .msg.error {
        color: #ff7a7a;
      }

      .position-box {
        margin-top: 10px;
        font-size: 14px;
        padding: 10px 12px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.03);
      }

      .waitlist-list {
        margin-top: 10px;
        max-height: 220px;
        overflow-y: auto;
        font-size: 13px;
        border-top: 1px solid #222;
        padding-top: 8px;
      }

      .waitlist-item {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        color: var(--muted);
      }

      .waitlist-item span.idx {
        color: var(--halo);
        font-weight: 600;
        margin-right: 6px;
      }

      .you {
        color: var(--accent);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Left / hero -->
      <div class="hero">
        <div class="brand">
          <span class="isee">isee</span><span class="halo">halo</span>
        </div>
        <p class="tagline">
          The <span class="highlight">music marketplace</span> where fans and artists share the upside.
        </p>
        <ul class="bullets">
          <li>Own limited copies of tracks you love.</li>
          <li>Support artists directly and earn with them.</li>
          <li>Early access to beta drops, events, and more.</li>
        </ul>
        <p class="small-note">
          Join the waitlist and weâ€™ll email you when your spot is ready. Youâ€™ll
          see your position right after signing up.
        </p>
      </div>

      <!-- Right / waitlist card -->
      <div class="card">
        <h2>Join the waitlist</h2>
        <p style="margin-top:0;font-size:13px;color:#bbbbbb;">
          Spots are rolling out gradually. Save your place now.
        </p>

        <label for="fullName">Name</label>
        <input id="fullName" type="text" placeholder="Your name" />

        <label for="email">Email</label>
        <input
          id="email"
          type="email"
          placeholder="you@example.com"
          autocomplete="email"
        />

        <button id="joinBtn">Join waitlist</button>

        <div id="msg" class="msg"></div>

        <div id="positionBox" class="position-box" style="display:none;"></div>

        <div id="listBox" class="waitlist-list" style="display:none;"></div>
      </div>
    </div>

    <!-- Supabase client -->
    <script type="module" src="/js/supabaseClient.js"></script>
    <script type="module">
      const $ = (id) => document.getElementById(id);
      const msg = $("msg");
      const btn = $("joinBtn");
      const nameEl = $("fullName");
      const emailEl = $("email");
      const posBox = $("positionBox");
      const listBox = $("listBox");

      function showMessage(text, kind = "") {
        msg.textContent = text;
        msg.className = "msg " + kind;
      }

      const setBusy = (yes) => {
        btn.disabled = yes;
      };

      // Helper: upsert + fetch queue
      async function joinWaitlist(fullName, email) {
        // 1) Upsert into waitlist (by email)
        const { error: upsertErr } = await window.supabase
          .from("waitlist")
          .upsert(
            {
              email,
              full_name: fullName || null,
            },
            { onConflict: "email" }
          );

        if (upsertErr) throw upsertErr;

        // 2) Fetch everyone ordered by created_at
        const { data, error } = await window.supabase
          .from("waitlist")
          .select("email, full_name, created_at")
          .order("created_at", { ascending: true });

        if (error) throw error;
        return data || [];
      }

      function renderQueue(queue, email) {
        if (!queue.length) {
          posBox.style.display = "none";
          listBox.style.display = "none";
          return;
        }

        // Find current user's index
        const idx = queue.findIndex((row) => row.email === email);
        const yourPos = idx === -1 ? null : idx + 1;

        if (yourPos) {
          posBox.style.display = "block";
          posBox.innerHTML = `
            You are <strong>#${yourPos}</strong> on the waitlist
            <br/>
            Total people in line: <strong>${queue.length}</strong>
          `;
        } else {
          posBox.style.display = "block";
          posBox.innerHTML = `
            You are on the waitlist.
            <br/>
            Total people in line: <strong>${queue.length}</strong>
          `;
        }

        // People ahead of you (or top N)
        listBox.style.display = "block";
        listBox.innerHTML = "";

        const maxShow = 15; // limit visible list
        queue.slice(0, maxShow).forEach((row, i) => {
          const div = document.createElement("div");
          div.className = "waitlist-item";
          const isYou = row.email === email;
          const displayName =
            row.full_name?.trim() ||
            row.email.split("@")[0].replace(/./g, (c, j) =>
              j === 0 ? c : "*"
            );

          div.innerHTML = `
            <span><span class="idx">#${i + 1}</span> ${
            isYou ? `<span class="you">${displayName} (you)</span>` : displayName
          }</span>
            <span>${new Date(row.created_at).toLocaleDateString()}</span>
          `;
          listBox.appendChild(div);
        });

        if (queue.length > maxShow) {
          const more = document.createElement("div");
          more.style.marginTop = "4px";
          more.style.fontSize = "12px";
          more.style.color = "#777";
          more.textContent = `â€¦and ${queue.length - maxShow} more in line.`;
          listBox.appendChild(more);
        }
      }

      btn.addEventListener("click", async () => {
        const fullName = nameEl.value.trim();
        const email = emailEl.value.trim().toLowerCase();

        if (!email || !email.includes("@")) {
          return showMessage("Please enter a valid email.", "error");
        }

        setBusy(true);
        showMessage("Adding you to the waitlistâ€¦");

        try {
          const queue = await joinWaitlist(fullName, email);
          showMessage("You're on the list! ðŸŽ‰", "success");
          renderQueue(queue, email);
        } catch (err) {
          console.error(err);
          showMessage(err.message || "Could not join waitlist.", "error");
        } finally {
          setBusy(false);
        }
      });
    </script>
  </body>
</html>
